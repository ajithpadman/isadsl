#include "tc18_formats.isa"
#include "tc18_registers.isa"
instructions {
    instruction ABS {
       format: RR
       encoding:{
        op1=0x0B,
        op2=0x1C
       }
       operands:s2,d 
       assembly_syntax: "ABS {d}, {s2}"
       behavior:{
        result = (D[s2] >= 0) ? D[s2] : (0 - D[s2]);
        msb = extract_bits(result,31,31);
        lsb = extract_bits(result,30,30);
        av = msb^lsb;
        PSW.AV = (av > 0) ? 1 : 0;
        PSW.SV = (av > 0) ? 1 : PSW.SV;
        PSW.V =  (result > 0x7FFFFFFF) ? 1 : 0;
        PSW.SV = (result > 0x7FFFFFFF) ? 1 : PSW.SV;
        D[d] = result;
       }
    }
    instruction ABS_B {
       format: RR
       encoding:{
        op1=0x0B,
        op2=0x5C
       }
       operands:s2,d 
       assembly_syntax: "ABS.B {d}, {s2}"
       behavior:{
        D_31_24 = sign_extend(extract_bits(D[s2], 31, 24), 8);
        D_23_16 = sign_extend(extract_bits(D[s2], 23, 16), 8);
        D_15_8 = sign_extend(extract_bits(D[s2], 15, 8), 8);
        D_7_0 = sign_extend(extract_bits(D[s2], 7, 0), 8);
        result3 = (D_31_24 >= 0) ? D_31_24 : (0 - D_31_24);
        result_byte3 = extract_bits(result3, 7,0);
        result2 = (D_23_16 >= 0) ? D_23_16 : (0 - D_23_16);
        result_byte2 = extract_bits(result2, 7,0);
        result1 = (D_15_8 >= 0) ? D_15_8 : (0 - D_15_8);
        result_byte1 = extract_bits(result1, 7,0);
        result0 = (D_7_0 >= 0) ? D_7_0 : (0 - D_7_0);
        result_byte0 = extract_bits(result0, 7,0);
        D[d] = (result_byte3<<24)| (result_byte2<<16)| (result_byte1<<8)|(result_byte0);
        PSW.V = ((result_byte3 > 0x7F) | (result_byte2 > 0x7F) |(result_byte1 > 0x7F) |(result_byte0 > 0x7F)) ? 1 : 0;
        PSW.SV = ((result_byte3 > 0x7F) | (result_byte2 > 0x7F) |(result_byte1 > 0x7F) |(result_byte0 > 0x7F)) ? 1 : PSW.SV;

       }
    }
    instruction ABS_H {
       format: RR
       encoding:{
        op1=0x0B,
        op2=0x7C
       }
       operands:s2,d 
       assembly_syntax: "ABS.H {d}, {s2}"
       behavior:{
        D_31_16 = sign_extend(extract_bits(D[s2], 31, 16), 16);
        D_15_0 = sign_extend(extract_bits(D[s2], 15, 0), 16);
        
        result1 = (D_31_16 >= 0) ? D_31_16 : (0 - D_31_16);
        result0 = (D_15_0 >= 0) ? D_15_0 : (0 - D_15_0);
        result_halfword1 = extract_bits(result1, 31,16);
        result_halfword0 = extract_bits(result0, 15,0);
        D[d] = (result_halfword1<<16)| (result_halfword0);

       }
    }

}