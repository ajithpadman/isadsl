name: Build and Publish to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:  # Allows manual triggering from GitHub Actions tab

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for trusted publishing (recommended method)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install UV
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies and run tests
      run: |
        uv sync --dev
        uv run pytest tests/ -v
    
    - name: Build package
      run: |
        uv build
    
    - name: Check package
      run: |
        uv pip install twine
        uv run twine check dist/*
    
    - name: Publish to PyPI (Trusted Publishing)
      if: github.event_name == 'release'
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        packages-dir: dist/
    
    # Alternative: Use username/password (if trusted publishing is not set up)
    # Uncomment and configure secrets if using this method:
    # - name: Publish to PyPI (Username/Password)
    #   if: github.event_name == 'release'
    #   env:
    #     TWINE_USERNAME: __token__
    #     TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
    #   run: |
    #     uv pip install twine
    #     uv run twine upload dist/*

