name: Publish VS Code Extension

on:
  release:
    types: [published]
  workflow_dispatch:  # Allows manual triggering from GitHub Actions tab
    inputs:
      version:
        description: 'Extension version to publish (e.g., 0.2.0)'
        required: false
        type: string

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: vscode_extension/isa/package-lock.json
    
    - name: Install dependencies (workspace root)
      working-directory: vscode_extension/isa
      run: |
        npm ci
    
    - name: Generate Langium code
      working-directory: vscode_extension/isa/packages/language
      run: |
        npm run langium:generate
    
    - name: Build language package
      working-directory: vscode_extension/isa/packages/language
      run: |
        npm run build
    
    - name: Build extension package
      working-directory: vscode_extension/isa/packages/extension
      run: |
        npm run build
    
    - name: Install vsce (VS Code Extension Manager)
      run: |
        npm install -g @vscode/vsce
    
    - name: Package extension
      working-directory: vscode_extension/isa/packages/extension
      run: |
        vsce package --out isa-dsl-language-server.vsix
    
    - name: Publish to VS Code Marketplace
      working-directory: vscode_extension/isa/packages/extension
      env:
        VSCE_PAT: ${{ secrets.VSCODE_MARKETPLACE_TOKEN }}
      run: |
        vsce publish -p $VSCE_PAT
    
    - name: Upload VSIX artifact
      uses: actions/upload-artifact@v4
      with:
        name: isa-dsl-language-server-vsix
        path: vscode_extension/isa/packages/extension/*.vsix
        retention-days: 30

